"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),GIFTOGIF2=function(){function t(e){_classCallCheck(this,t),this.judgeGIF(e.files),this.gifObj=e,this.stepX=Number(this.gifObj.stepX)||10,this.stepY=Number(this.gifObj.stepX)||10,this.direction=this.gifObj.direction.toUpperCase()||"ALL",this.totalStep=Number(this.gifObj.totalStep)||200,this.width=Number(this.gifObj.width)||100,this.height=Number(this.gifObj.height)||100,this.init()}return _createClass(t,[{key:"judgeGIF",value:function(t){if(!t||t.length<2)throw new Error("请上传两张素材图片");if(!t.every(function(t){return/(image\/gif)/.test(t.file.type)}))throw new Error("请上传gif格式图片")}},{key:"init",value:function(){this.bg="BG",this.imgList=[],this.renderFinished=!1,this.promiseList=[],this.total=2,this.initBgImg(),this.gif=this.transfromGIF(),this.cvs=this.initCanvas()}},{key:"initBgImg",value:function(){var t=this;this.gifObj.files.forEach(function(e){e.type&&e.type.toUpperCase()==t.bg?t.initGifObject(e.file,t.bg):t.initGifObject(e.file)})}},{key:"initCanvas",value:function(){var t=document.createElement("canvas");return document.body.appendChild(t),t}},{key:"transfromGIF",value:function(){var t=new GIF({workers:4,quality:10,workerScript:"./dist/gif.worker.js"});return t.on("finished",function(t){var e=new FileReader;e.readAsDataURL(t),e.onload=function(){var t=document.createElement("img");t.src=e.result,document.body.appendChild(t)}}),t}},{key:"imgLoad",value:function(t){for(var e=this,i=[],n=[],r=0;r<this.imgList.length;r++)!function(t){i[t]=new Promise(function(i,r){n[t]=new Image,n[t].src=e.imgList[t],n[t].onload=function(){i(n[t])}})}(r);return{promiseAll:i,type:t}}},{key:"judgeImgLoad",value:function(t){var e=this,i=this.imgLoad(t);this.promiseify(i.promiseAll).then(function(i){e.promiseList.push({list:i,type:t}),e.promiseList.length==e.total&&e.drawCanvas(e.promiseList)})}},{key:"handleBgList",value:function(t){var e=this,i=void 0,n=void 0;return t.forEach(function(t){t.type&&t.type.toUpperCase()==e.bg?n=t.list:i=t.list}),[i,n]}},{key:"drawCanvas",value:function(t){var e=this,i=this.handleBgList(t),n=i[0],r=i[1],s=this.cvs.getContext("2d"),a=0,o=0;setInterval(function(){clearInterval,s.clearRect(0,0,e.cvs.width,e.cvs.height),r?s.drawImage(r[o],0,0,e.cvs.width,e.cvs.height):s.drawImage(n[a],0,0,e.cvs.width,e.cvs.height),s.drawImage(n[a],0,0,n[a].width,n[a].height,"ALL"==e.direction?e.stepX++:"X"==e.direction?e.stepX++:0,"ALL"==e.direction?e.stepY++:"Y"==e.direction?e.stepY++:0,e.width,e.height),++a>=n.length&&(a=0),++o>=r.length&&(o=0),++e.stepX>=e.totalStep&&(e.stepX=0),++e.stepY>=e.totalStep&&(e.stepY=0),e.renderFinished||e.addFrame(e.cvs,n.length)},60)}},{key:"addFrame",value:function(t,e){this.renderFinished||(this.gif.frames.length<e+100?this.gif.addFrame(t,{copy:!0,delay:100}):(this.gif.render(),this.renderFinished=!0,this.addFrame=null))}},{key:"initGifObject",value:function(t,e){var i=this,n=document.createElement("img");n.setAttribute("rel:animated_src",URL.createObjectURL(t)),n.setAttribute("rel:auto_play","0"),document.body.appendChild(n);var r=new SuperGif({gif:n}),s=[];r.load(function(){for(var t=1;t<=r.get_length();t++)r.move_to(t),s.push(r.get_canvas().toDataURL("image/png"));i.imgList=s,i.judgeImgLoad(e)})}},{key:"promiseify",value:function(t){return Promise.all(t)}}]),t}();